<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>LostMind AI - ContextKeeper</title>
    <meta name="description" content="ContextKeeper: Revolutionary AI-Powered Development Context Management by LostMindAI.">
    <meta name="author" content="LostMindAI">

    <!-- Tailwind CSS & Google Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* Base styles matching the template */
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #e2e8f0;
        }

        /* Container for the three.js canvas background */
        #three-canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* The main content area that will scroll over the fixed canvas */
        .main-content {
            position: relative;
            z-index: 10;
            background-color: #0a0a0a;
        }

        /* The hero section that fills the initial viewport */
        .hero-section {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }
        
        /* Custom scrollbar for a modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Animation for the loading spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #a78bfa; /* A nice violet color */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
    </style>
</head>
<body class="antialiased">

    <!-- three.js canvas container -->
    <div id="three-canvas-container"></div>

    <!-- Hero Section -->
    <section class="hero-section text-center p-4">
        <h1 class="text-4xl md:text-6xl font-black text-white leading-tight mb-4">
            ContextKeeper
        </h1>
        <p class="max-w-3xl mx-auto text-lg text-slate-400">
            Revolutionary AI-Powered Development Context Management.
        </p>
        <div class="absolute bottom-8 text-slate-500 animate-bounce">
            <a href="#dashboard-content" aria-label="Scroll to content">
                <i class="fas fa-chevron-down text-2xl"></i>
            </a>
        </div>
    </section>

    <!-- Main Dashboard Content -->
    <main id="dashboard-content" class="main-content">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16 sm:py-24">

            <!-- Stats Grid -->
            <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="statsGrid">
                <!-- Stat Card Template -->
                <div class="bg-slate-900/50 p-6 rounded-lg border border-slate-800 text-center transition-all duration-300 hover:border-violet-500 hover:shadow-2xl hover:shadow-violet-500/10">
                    <div class="text-4xl mb-3 text-violet-400"><i class="fas fa-folder-open"></i></div>
                    <div class="text-3xl font-bold text-white" id="totalProjects">-</div>
                    <div class="text-sm font-medium text-slate-400 uppercase tracking-wider">Active Projects</div>
                </div>
                <div class="bg-slate-900/50 p-6 rounded-lg border border-slate-800 text-center transition-all duration-300 hover:border-pink-500 hover:shadow-2xl hover:shadow-pink-500/10">
                    <div class="text-4xl mb-3 text-pink-400"><i class="fas fa-crosshairs"></i></div>
                    <div class="text-3xl font-bold text-white" id="focusedProject">-</div>
                    <div class="text-sm font-medium text-slate-400 uppercase tracking-wider">Focused Project</div>
                </div>
                <div class="bg-slate-900/50 p-6 rounded-lg border border-slate-800 text-center transition-all duration-300 hover:border-cyan-500 hover:shadow-2xl hover:shadow-cyan-500/10">
                    <div class="text-4xl mb-3 text-cyan-400"><i class="fas fa-lightbulb"></i></div>
                    <div class="text-3xl font-bold text-white" id="totalDecisions">-</div>
                    <div class="text-sm font-medium text-slate-400 uppercase tracking-wider">Total Decisions</div>
                </div>
                <div class="bg-slate-900/50 p-6 rounded-lg border border-slate-800 text-center transition-all duration-300 hover:border-green-500 hover:shadow-2xl hover:shadow-green-500/10">
                    <div class="text-4xl mb-3 text-green-400"><i class="fas fa-heart-pulse"></i></div>
                    <div class="text-3xl font-bold text-white" id="systemHealth">-</div>
                    <div class="text-sm font-medium text-slate-400 uppercase tracking-wider">System Health</div>
                </div>
            </section>

            <!-- Controls -->
            <section class="flex flex-wrap gap-4 justify-center mb-12">
                <button class="bg-violet-600 hover:bg-violet-700 text-white font-semibold py-2 px-5 rounded-lg inline-flex items-center gap-2 transition-all duration-200 transform hover:scale-105" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-5 rounded-lg inline-flex items-center gap-2 transition-all duration-200 transform hover:scale-105" onclick="openAnalytics()">
                    <i class="fas fa-chart-line"></i> Analytics
                </button>
                <button class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-5 rounded-lg inline-flex items-center gap-2 transition-all duration-200 transform hover:scale-105" onclick="openAPI()">
                    <i class="fas fa-code"></i> API Docs
                </button>
                <button class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-5 rounded-lg inline-flex items-center gap-2 transition-all duration-200 transform hover:scale-105" onclick="openGitHub()">
                    <i class="fab fa-github"></i> GitHub
                </button>
            </section>

            <!-- Projects Section -->
            <section class="bg-slate-900/50 border border-slate-800 rounded-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-800 flex justify-between items-center flex-wrap gap-4">
                    <h2 class="text-xl font-bold text-white flex items-center gap-3">
                        <i class="fas fa-folder"></i> Your Projects
                    </h2>
                     <button class="bg-white text-violet-600 font-bold py-2 px-5 rounded-full hover:bg-slate-200 transition-colors transform hover:scale-105 duration-300 inline-flex items-center gap-2 text-sm" onclick="openCreateProjectModal()">
                        <i class="fas fa-plus"></i> Create New Project
                    </button>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="projectsGrid">
                    <!-- Loading State -->
                    <div class="loading-state col-span-full text-center py-10 text-slate-400">
                        <div class="spinner"></div>
                        <p>Loading projects...</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Create Project Modal -->
    <div id="createProjectModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
        <div class="bg-slate-900 border border-slate-800 rounded-lg shadow-2xl p-8 w-full max-w-md m-4">
            <h3 class="text-2xl font-bold text-white mb-4">Create a New Project</h3>
            <p class="text-slate-400 mb-6">Enter a name for your new project to get started.</p>
            <div>
                <label for="projectName" class="block text-sm font-medium text-slate-300 mb-2">Project Name</label>
                <input type="text" id="projectName" name="projectName" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg px-4 py-2 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 outline-none" placeholder="e.g., 'My Awesome App'">
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button type="button" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-5 rounded-lg transition-colors" onclick="closeCreateProjectModal()">
                    Cancel
                </button>
                <button type="button" class="bg-violet-600 hover:bg-violet-700 text-white font-semibold py-2 px-5 rounded-lg transition-colors" onclick="handleCreateProject()">
                    Create Project
                </button>
            </div>
        </div>
    </div>


    <!-- three.js and app logic scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/lights/RectAreaLightUniformsLib.js"></script>
    
    <script>
        // === DASHBOARD LOGIC ===
        const API_BASE = window.location.origin;
        let refreshInterval;

        // Initialize dashboard on content load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded, starting data fetch...');
            loadDashboard();
            // Refresh data every 30 seconds
            refreshInterval = setInterval(loadDashboard, 30000);
        });

        async function loadDashboard() {
            try {
                console.log('Loading dashboard data...');
                await Promise.all([
                    loadStats(),
                    loadProjects()
                ]);
                console.log('Dashboard data loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load dashboard data: ' + error.message);
            }
        }

        async function loadStats() {
            try {
                console.log('Loading stats...');
                // In a real scenario, you might have separate endpoints.
                // For this example, we derive some stats from the projects endpoint.
                const [projectsResponse, healthResponse] = await Promise.all([
                    fetch(`${API_BASE}/projects`).catch(e => ({ ok: false, status: 'Fetch Error', error: e })),
                    fetch(`${API_BASE}/health`).catch(e => ({ ok: false, status: 'Fetch Error', error: e }))
                ]);

                if (!projectsResponse.ok) {
                    // Mock data for demonstration if API fails
                    console.warn('Projects API failed or is unavailable. Using mock stats.');
                    updateStatsUI({ total_projects: 3, focused_project: 'ContextKeeper', total_decisions: 12 }, { status: 'healthy' });
                    return;
                }
                 if (!healthResponse.ok) {
                    console.warn('Health API failed or is unavailable. Using mock health.');
                    updateStatsUI(await projectsResponse.json(), { status: 'healthy' });
                    return;
                }

                const projectsData = await projectsResponse.json();
                const healthData = await healthResponse.json();
                console.log('Stats data:', { projectsData, healthData });
                updateStatsUI(projectsData, healthData);

            } catch (error) {
                console.error('Error loading stats:', error);
                // Display error state in UI
                document.getElementById('totalProjects').textContent = 'Error';
                document.getElementById('focusedProject').textContent = 'Error';
                document.getElementById('totalDecisions').textContent = 'Error';
                document.getElementById('systemHealth').textContent = '❌';
            }
        }
        
        function updateStatsUI(projectsData, healthData) {
            document.getElementById('totalProjects').textContent = projectsData.total_projects || 0;
            document.getElementById('focusedProject').textContent = projectsData.focused_project ? 'Active' : 'None';
            document.getElementById('totalDecisions').textContent = projectsData.total_decisions || 0;
            document.getElementById('systemHealth').textContent = healthData.status === 'healthy' ? '✅ Healthy' : '❌ Unhealthy';
        }


        async function loadProjects() {
            const projectsGrid = document.getElementById('projectsGrid');
            try {
                console.log('Loading projects...');
                const response = await fetch(`${API_BASE}/projects`);
                
                if (!response.ok) {
                    // Mock data for demonstration if API fails
                    console.warn(`Projects API error: ${response.status}. Displaying mock projects.`);
                    const mockData = {
                        projects: [
                            { id: 'proj_1', name: 'ContextKeeper v3', status: 'active', last_active: new Date().toISOString(), total_decisions: 12 },
                            { id: 'proj_2', name: 'AI Core Engine', status: 'active', last_active: new Date(Date.now() - 86400000).toISOString(), total_decisions: 45 },
                            { id: 'proj_3', name: 'Frontend UI Library', status: 'paused', last_active: new Date(Date.now() - 86400000 * 5).toISOString(), total_decisions: 8 },
                            { id: 'proj_4', name: 'Legacy API', status: 'archived', last_active: new Date(Date.now() - 86400000 * 30).toISOString(), total_decisions: 150 },
                        ]
                    };
                    renderProjects(mockData);
                    return;
                }
                
                const data = await response.json();
                console.log('Projects data:', data);
                renderProjects(data);

            } catch (error) {
                console.error('Error loading projects:', error);
                projectsGrid.innerHTML = `
                    <div class="col-span-full text-center py-10 bg-red-900/20 border border-red-500/30 rounded-lg">
                        <p class="text-red-300">Error loading projects: ${error.message}</p>
                        <button class="mt-4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg" onclick="loadProjects()">Retry</button>
                    </div>
                `;
            }
        }
        
        function renderProjects(data) {
            const projectsGrid = document.getElementById('projectsGrid');
            if (data.projects && data.projects.length > 0) {
                projectsGrid.innerHTML = data.projects.map(project => {
                    const statusClasses = {
                        active: 'bg-green-500/20 text-green-300',
                        paused: 'bg-yellow-500/20 text-yellow-300',
                        archived: 'bg-slate-600/30 text-slate-400'
                    };
                    return `
                        <div class="project-card bg-slate-800/50 p-5 rounded-lg border border-slate-700 transition-all duration-300 hover:border-violet-500 hover:-translate-y-1 cursor-pointer" onclick="focusProject('${project.id}')">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-bold text-white text-lg">${project.name}</h3>
                                <span class="text-xs font-medium uppercase tracking-wider px-3 py-1 rounded-full ${statusClasses[project.status] || statusClasses.archived}">
                                    ${project.status}
                                </span>
                            </div>
                            <div class="text-sm text-slate-400 space-y-1">
                                <div><i class="fas fa-clock fa-fw mr-2"></i>Last Active: ${formatDate(project.last_active)}</div>
                                <div><i class="fas fa-lightbulb fa-fw mr-2"></i>Decisions: ${project.total_decisions || 0}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                projectsGrid.innerHTML = `
                    <div class="col-span-full text-center py-10 text-slate-400">
                        <i class="fas fa-folder-open text-4xl mb-4"></i>
                        <p>No projects yet. Create your first one to get started!</p>
                    </div>
                `;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Never';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-AU', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch (error) {
                return 'Invalid Date';
            }
        }

        function refreshData() {
            console.log('Manual refresh triggered');
            // Add a visual cue for refreshing
            const refreshButton = document.querySelector('.fa-sync-alt');
            refreshButton.classList.add('animate-spin');
            loadDashboard().finally(() => {
                setTimeout(() => refreshButton.classList.remove('animate-spin'), 500);
            });
        }

        function focusProject(projectId) {
            console.log('Focusing project:', projectId);
            // This is a mock interaction. In a real app, you would make an API call.
            showNotification(`Project '${projectId}' is now focused.`);
            // fetch(`${API_BASE}/projects/${projectId}/focus`, { method: 'POST' })
            // .then(() => loadDashboard())
            // .catch(error => console.error('Error focusing project:', error));
        }
        
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-pulse';
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.remove();
            }, 3000);
        }

        // Modal Controls
        function openCreateProjectModal() {
            document.getElementById('createProjectModal').classList.remove('hidden');
        }

        function closeCreateProjectModal() {
            document.getElementById('createProjectModal').classList.add('hidden');
        }

        function handleCreateProject() {
            const projectName = document.getElementById('projectName').value;
            if (projectName) {
                console.log('Creating project:', projectName);
                closeCreateProjectModal();
                showNotification(`Project '${projectName}' created successfully!`);
                // In a real app, you would make an API call:
                // fetch(`${API_BASE}/projects`, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ name: projectName, /* other data */ })
                // }).then(() => loadDashboard()).catch(err => console.error(err));
            }
        }
        
        // External Links
        function openAnalytics() { window.open(`${API_BASE}/analytics_dashboard_live.html`, '_blank'); }
        function openAPI() { window.open('https://github.com/lostmind008/contextkeeper-v3', '_blank'); }
        function openGitHub() { window.open('https://github.com/lostmind008/contextkeeper-v3', '_blank'); }

        // Cleanup and error handling
        window.addEventListener('beforeunload', () => clearInterval(refreshInterval));
        window.addEventListener('unhandledrejection', event => console.error('Unhandled promise rejection:', event.reason));


        // === THREE.JS SCENE SETUP (from template) ===
        let scene, camera, renderer;
        let points, group;
        let mouse = new THREE.Vector2(-100, -100);
        let raycaster = new THREE.Raycaster();
        let intersectionPoint = new THREE.Vector3();
        let isHovering = false;

        const SPHERE_RADIUS = 3.5;
        const PARTICLE_COUNT = 4000;
        const HOVER_DISTANCE_EFFECT = 2.5;
        const DISINTEGRATION_STRENGTH = 0.5;

        function initThreeJS() {
            const container = document.getElementById('three-canvas-container');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(0, 0, 18);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setAnimationLoop(animate);
            container.appendChild(renderer.domElement);
            
            THREE.RectAreaLightUniformsLib.init();
            const rectLight1 = new THREE.RectAreaLight(0xff0000, 5, 4, 10);
            rectLight1.position.set(-5, 5, 5);
            scene.add(rectLight1);
            const rectLight2 = new THREE.RectAreaLight(0x00ff00, 5, 4, 10);
            rectLight2.position.set(0, 5, 5);
            scene.add(rectLight2);
            const rectLight3 = new THREE.RectAreaLight(0x0000ff, 5, 4, 10);
            rectLight3.position.set(5, 5, 5);
            scene.add(rectLight3);

            group = new THREE.Group();
            scene.add(group);

            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const initialPositions = [];
            const colors = [];
            const colorTop = new THREE.Color(0xffffff);
            const colorBottom = new THREE.Color(0xFFD700);
            const phi = Math.PI * (3.0 - Math.sqrt(5.0));

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const y = 1 - (i / (PARTICLE_COUNT - 1)) * 2;
                const radiusAtY = Math.sqrt(1 - y * y);
                const theta = phi * i;
                const x = Math.cos(theta) * radiusAtY * SPHERE_RADIUS;
                const z = Math.sin(theta) * radiusAtY * SPHERE_RADIUS;
                const yPos = y * SPHERE_RADIUS;
                positions.push(x, yPos, z);
                initialPositions.push(x, yPos, z);
                const color = new THREE.Color();
                color.lerpColors(colorBottom, colorTop, (y + 1) / 2);
                colors.push(color.r, color.g, color.b);
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('initialPosition', new THREE.Float32BufferAttribute(initialPositions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.05,
                vertexColors: true,
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending,
            });

            points = new THREE.Points(geometry, material);
            group.add(points);

            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            document.addEventListener('touchstart', onDocumentTouch, { passive: false });
            document.addEventListener('touchmove', onDocumentTouch, { passive: false });
            document.addEventListener('touchend', () => { isHovering = false; });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function updateMouseAndRaycaster(clientX, clientY) {
            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const invisibleSphere = new THREE.Mesh(new THREE.SphereGeometry(SPHERE_RADIUS, 32, 32));
            group.add(invisibleSphere);
            invisibleSphere.updateMatrixWorld();
            const intersects = raycaster.intersectObject(invisibleSphere);
            group.remove(invisibleSphere);
            if (intersects.length > 0) {
                intersectionPoint.copy(intersects[0].point).applyMatrix4(group.matrixWorld.clone().invert());
                isHovering = true;
            } else {
                isHovering = false;
            }
        }

        function onDocumentMouseMove(event) { updateMouseAndRaycaster(event.clientX, event.clientY); }
        function onDocumentTouch(event) {
            if (event.touches.length === 1) {
                updateMouseAndRaycaster(event.touches[0].clientX, event.touches[0].clientY);
            }
        }

        function animate() {
            group.rotation.y += 0.0005;
            group.rotation.x += 0.0002;
            
            const positions = points.geometry.attributes.position;
            const initialPositions = points.geometry.attributes.initialPosition;
            const currentPos = new THREE.Vector3();
            const initialPos = new THREE.Vector3();
            const targetPos = new THREE.Vector3();

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                currentPos.fromBufferAttribute(positions, i);
                initialPos.fromBufferAttribute(initialPositions, i);
                let targetPosCalculated = false;
                if (isHovering) {
                    const dist = initialPos.distanceTo(intersectionPoint);
                    if (dist < HOVER_DISTANCE_EFFECT) {
                        const pushFactor = (1 - dist / HOVER_DISTANCE_EFFECT);
                        targetPos.copy(initialPos).multiplyScalar(1 + pushFactor * DISINTEGRATION_STRENGTH);
                        targetPosCalculated = true;
                    }
                }
                if (!targetPosCalculated) {
                    targetPos.copy(initialPos);
                }
                currentPos.lerp(targetPos, 0.05);
                positions.setXYZ(i, currentPos.x, currentPos.y, currentPos.z);
            }
            positions.needsUpdate = true;
            renderer.render(scene, camera);
        }

        // Start the three.js visualization
        initThreeJS();
    </script>
</body>
</html>